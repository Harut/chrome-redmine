<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>

		<script type="text/javascript">
            var css = localStorage.redmine_url + 'themes/alternate/stylesheets/application.css'; // XXX
            document.write('<link href="'+ css +'" rel="stylesheet" type="text/css">')
        </script>

		<style>
        body {
            min-width:350px;
            overflow-x: hidden;
        }
        #tasks{
            padding: 0; margin: 0;
            font-size: 12px;
            font-family: sans;
        }
        #tasks td{
            padding:2px;
        }
		</style>
			
		<script type="text/javascript">
			function LoadPage(){
				load_tasks();
			}

            function load_tasks(){
                var xhr = new XMLHttpRequest();
                xhr.onload = function(e){
                    var tasks = JSON.parse(this.responseText).issues;
                    var ul = document.getElementById('tasks');
                    var oddeven = 'odd';

                    var new_tasks = JSON.parse(localStorage.new_tasks || '{}');

                    for (var i=0; i<tasks.length; i++){
                        var task = document.createElement('tr');
                        var td1 = document.createElement('td');
                        var link = document.createElement('a');
                        link.setAttribute('href', localStorage["redmine_url"] +'issues/' + tasks[i].id);
                        link.innerText = tasks[i].subject;
                        link.addEventListener('click', function(){
                            window.open(this.href);
                        });
                        if(new_tasks[tasks[i].id] !== false){
                            link.style.fontWeight = 'bold';
                        }
                        var td2 = document.createElement('td');
                        td2.innerText = tasks[i].status.name;

                        var priority = {
                            1: 2, 2: 1, 3: 3
                        }[tasks[i].priority.id];
                        
                        var cls = 'status-' + tasks[i].status.id + ' priority-' + priority + ' ' + oddeven;
                        oddeven = (oddeven == 'odd')? 'even':'odd';
                        task.setAttribute('class', cls);
                        

                        task.appendChild(td1);
                        task.appendChild(td2);
                        td1.appendChild(link);
                        ul.appendChild(task);
                    }
                }
                xhr.open('GET', localStorage.redmine_url + 'issues.json?'+localStorage.filter+'&sort=priority%3Adesc&limit=100', true);
                xhr.send(null);
            }
		
			
	  </script>
	</head>
	<body onload="LoadPage();">
        <table id='tasks'></table>
	</body>
</html>
