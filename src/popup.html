<html>
	<head>
	  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
      <link href="popup.css" rel="stylesheet" type="text/css"/>

      <style>
        #tasks{
            padding: 0; margin: 0;
            font-size: 12px;
            font-family: sans;
        }
        #tasks tr>td:first-child { text-align: left}
        #tasks td { padding: 4px; border-width: 1px; border-style: solid;}
	  </style>
			
	  <script type="text/javascript">
		function LoadPage(){
			load_tasks();
		}

        function load_tasks(){
            var xhr = new XMLHttpRequest();
            xhr.onload = function(e){
                var tasks = JSON.parse(this.responseText).issues;
                var ul = document.getElementById('tasks');
                var oddeven = 'odd';

                var new_tasks = JSON.parse(localStorage.new_tasks || '{}');

                for (var i=0; i<tasks.length; i++){
                    var task = document.createElement('tr');
                    var td1 = document.createElement('td');
                    var link = document.createElement('a');
                    link.setAttribute('href', localStorage["redmine_url"] +'issues/' + tasks[i].id);
                    link.innerText = tasks[i].subject;
                    link.addEventListener('click', function(){
                        window.open(this.href);
                    });
                    if(new_tasks[tasks[i].id] !== false){
                        link.style.fontWeight = 'bold';
                    }
                    var td2 = document.createElement('td');
                    td2.innerText = tasks[i].status.name;

                    var td3 = document.createElement('td');
                    td3.innerText = tasks[i].project.name;

                    var priority = JSON.parse(localStorage.priorities)[tasks[i].priority.id].color;
                    
                    var cls = 'issue status-' + tasks[i].status.id + ' priority-' + priority + ' ' + oddeven;
                    oddeven = (oddeven == 'odd')? 'even':'odd';
                    task.setAttribute('class', cls);
                    

                    task.appendChild(td1);
                    task.appendChild(td2);
                    task.appendChild(td3);
                    td1.appendChild(link);
                    ul.appendChild(task);
                }
            }
            xhr.open('GET', localStorage.redmine_url + 'issues.json?'+localStorage.filter+'&sort=priority%3Adesc&limit=100', true);
            xhr.send(null);
        }

		function change_status(issue_id, status_id, callback){
            var xhr = new XMLHttpRequest();
            if(callback) { xhr.onload = callback; }
            xhr.open('PUT', localStorage.redmine_url + 'issues/' + issue_id + '.xml', true);
            xhr.send('<?xml version="1.0"?><issue><status_id>' + status_id + '</status_id></issue>');
        }

	  </script>
	</head>
	<body onload="LoadPage();">
        <table id='tasks' class="list"></table>
	</body>
</html>
