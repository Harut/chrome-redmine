<html>
  <script>
    /*
    chrome.tabs.onCreated.addListener(function(tab) {
    });*/
	
    localStorage.viewed_tasks = localStorage.viewed_tasks || '{}';
    localStorage.filter = localStorage.filter || 'assigned_to_id=me';
    if(!localStorage.priorities){ load_priorities(); }

	// creating the updated event , raise when an tab is updated , check the url to know if a redmine is currently viewed, and add to the redmine history
	chrome.tabs.onUpdated.addListener(function(tabid, changeInfo, tab){
	
		if (tab.url){
			var url = tab.url;
			var issues_url = get_issue_url();
			
			if (url.indexOf(issues_url) != 0){
				return;
            }
			
			//// adding the bug in the history
			 var task_id = parseInt(url.substr(issues_url.length).replace(/\//g, ''));

			 var views = JSON.parse(localStorage.viewed_tasks)
			 if (!isNaN(task_id)){
                views[task_id] = new Date();
                localStorage.viewed_tasks = JSON.stringify(views);
                recalculate();
			 }
		}
    });

    function get_issue_url(id){
		var url = localStorage.redmine_url + (localStorage.redmine_prefix || 'issues/');
        if(id){
            url += id;
        }
        return url;
    }

    //window.setInterval(5*6*1000, function(){
    window.setInterval(recalculate, 5000);

    function recalculate(){
        var xhr = new XMLHttpRequest();
        xhr.onload = function(e){
            var count = 0;
            var views = JSON.parse(localStorage.viewed_tasks);
            var tasks = JSON.parse(this.responseText).issues;
            var statuses = {}
            for (var i=0; i<tasks.length; i++){
                var viewed = views[tasks[i].id + ''];
                viewed = viewed?new Date(viewed): null;
                var updated = new Date(tasks[i].updated_on);
                statuses[tasks[i].id] = !viewed || updated > viewed;
                if (statuses[tasks[i].id]){
                    count++;
                } 
            }
            localStorage.new_tasks = JSON.stringify(statuses);
            chrome.browserAction.setBadgeText({'text': (count || '') + ''});
        }
        xhr.open('GET', localStorage.redmine_url + 'issues.json?'+localStorage.filter+'&limit=100', true);
        xhr.send(null);
    }

    function load_priorities(){
        var xhr = new XMLHttpRequest();
        xhr.open('GET', localStorage.redmine_url + 'issues', true);
        xhr.onload = function(e){
            var priorities = {};
            var options = RegExp('<select[^>]+id="values_priority_id".*?>(.+?)</select>').exec(this.response.replace(/\s+/g, ' '))[1];
            options = options.match(RegExp('<option value="(.+?)">(.+?)</option>', 'g'));

            console.log(options)
            for (var i=0; i<options.length; i++){
                var option = RegExp('<option value="(.+?)">(.+?)</option>').exec(options[i]);
                priorities[option[1]] = {color: Math.min(i+1, 5), name: option[2]};
            }
            localStorage.priorities = JSON.stringify(priorities);
        }
        xhr.send(null);
    }
  </script>
</html>
