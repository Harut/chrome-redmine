<html>
<head><title>Redmine Extension</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="options.css"/>

<script type="text/javascript">
	// Сохраняем настройки в localStorage
	function save_options() {
	    
		var page_state = document.getElementById('page_state');
		
		page_state.innerHTML = "";

		/* REDMINE URL */ 
		var redmine_url = document.getElementById('redmine_url');
		if (!redmine_url.value) {
			//page_state.innerHTML += "Пустой URL. ";
            //page_state.style.color = 'red';
            //page_state.className = 'show';
            redmine_url.classList.add('error');
			return;
		} else {
		    redmine_url.classList.remove('error');
			localStorage["redmine_url"] = redmine_url.value;
		}
		
		var timeout_id;
		
		/* INTERVAL UPDATE */ 
		var interval_upd = document.getElementById('interval_upd');
		if (!interval_upd.value) {
            //page_state.innerHTML += "Не указан интервал. ";
            //page_state.style.color = 'red';
            //page_state.className = 'show';
            interval_upd.classList.add('error');
            
			return;
		} else {
		    interval_upd.classList.remove('error');
			localStorage["interval_upd"] = interval_upd.value;
		}
		
        /* TABS UPDATE */
        var tabs = document.querySelectorAll('#tabs-list>div');
        var tabs_conf = [];
        for (var i=0; i<tabs.length; i++){
            var data = {};
            var tab = tabs[i];

            data.name = tab.querySelector('[name=name]').value;
            data.filter = tab.querySelector('[name=filter]').value;
            data.show_status = tab.querySelector('[name=show_status]').checked;
            data.show_project = tab.querySelector('[name=show_project]').checked;
            data.show_assignee = tab.querySelector('[name=show_assignee]').checked;

            tabs_conf.push(data);
        }
        localStorage["tabs"] = JSON.stringify(tabs_conf);

        page_state.innerHTML = "Сохранено.";		
	}

	// Восстанавливаем сохраненные ранее опции из localStorage
	function restore_options() {
		
		/* REDMINE URL */
		var redmine_url = localStorage["redmine_url"];
		if (redmine_url) {
			document.getElementById('redmine_url').setAttribute("value", redmine_url);
		}
		
		/* INTERVAL UPDATE */
		var interval_upd = localStorage["interval_upd"];
		if (interval_upd) {
			document.getElementById('interval_upd').setAttribute("value", interval_upd);
		}
		
		
		var inputs = document.getElementsByTagName('input');

        for (var i=0; i<inputs.length; i++) {
            if (inputs[i].type == 'text' || inputs[i].type == 'number') {
                inputs[i].onfocus = function() {
                    this.parentNode.parentNode.classList.add('focus');
                }
                inputs[i].onblur = function() {
                    this.parentNode.parentNode.classList.remove('focus');
                }
            }
        }
        
        //if (localStorage.priorities) {
        //    var pp = document.getElementById('priorities');
        //    pp.parentNode.parentNode.classList.add('enabled');
        //    pp.parentNode.parentNode.style.display = 'block';
        //}

        function draw_tab(data){
            var tab = document.createElement('div');
            tab.innerHTML = document.getElementById('tab-to-clone').innerHTML;

            tab.querySelector('[name=name]').setAttribute('value', data.name || '');
            tab.querySelector('[name=filter]').setAttribute('value', data.filter || '');
            tab.querySelector('[name=show_status]').checked = data.show_status;
            tab.querySelector('[name=show_project]').checked = data.show_project;
            tab.querySelector('[name=show_assignee]').checked = data.show_assignee;

            tab.querySelector('.delete-tab').addEventListener('click', function(){
                this.parentNode.parentNode.removeChild(this.parentNode);
            });

            document.getElementById('tabs-list').appendChild(tab);
        }
        if (localStorage.tabs){
            var tabs = JSON.parse(localStorage.tabs);
            for (var i=0; i<tabs.length; i++){
                draw_tab(tabs[i]);
            }
        }

        document.getElementById('add-tab').addEventListener('click', function(){
            draw_tab({});
        });

        

	}

	

</script>

</head>
<body onload="restore_options()">

<div id="wrapper">

    <h1 class="page_title">Redmine Extension</h1>
    
    
    
    <div class="inner_wrapper">
        <p>Авторы и другая текстовая инфа, аля Welcome ;)</p>
        <h2 class="section_title">Главные настройки</h2>
        <ul class="options">
            <li class="opt">
                <div class="option">
                    <label for="redmine_url">URL на Redmine<span class="req">*</span>:</label>
                    <input id="redmine_url" type="text" size="60" />
                </div>
            </li>
            <li class="opt">
                <div class="option">
                    <label for="interval_upd">Интервал обновлений (в мин)<span class="req">*</span>:</label>
                    <input id="interval_upd" class="small" type="number" size="5"  />
                </div>
            </li>
            <li class="buttons">
                <div class="state"><p id="page_state"></p></div>
                <input name="commit" type="button" onclick="save_options()" value="Сохранить"/>
                
            </li>
        </ul>
        
        
        <h2 class="section_title">Фильтры</h2>
        <ul class="options">

            <li class="opt" style="display:none;">
                <div class="option">
                    <label for="priorities">Приоритеты:</label>
                    
                </div>
            </li>

            <li class="opt">
                <div class="option">
                    <!--label>Вкладки:</label-->
                    <div id="tabs-list"></div>
                    <div id="tab-to-clone" style="display: none">
                        <label>Название</label> <input name="name" type="text"/><br/>
                        <label>Фильтр</label> <input name="filter" type="text" size="60"/><br/>
                        <small>будет использоваться для запроса к API Redmine.</small>

                        <label><input name="show_status" type="checkbox" />
                            Показывать колонку статуса</label>
                        <label><input name="show_project" type="checkbox" />
                            Показывать колонку проекта</label>
                        <label><input name="show_assignee" type="checkbox" />
                            Показывать колонку исполнителя</label>

                        <a class="delete-tab">Удалить</a>
                    </div>
                    <a id="add-tab">+</a>
                </div>
            </li>

            <li class="buttons">
                <div class="state"><p id="page_state"></p></div>
                <input name="commit" type="button" onclick="save_options()" value="Сохранить"/>
                
            </li>
        </ul>
    </div>
</div>

</body>
</html>
